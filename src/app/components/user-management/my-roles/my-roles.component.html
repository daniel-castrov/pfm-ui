<j-header></j-header>
<div class="container-fluid">
  <div class="row main-content" *ngIf="header.isAuthenticated">
    <div class="col-12">
      <div class="row mb-4">
        <div class="col-12">
          <span class="h5 mr-3">My Roles</span>
        </div>
      </div>

      <fieldset>
        <legend>My Assigned Roles</legend>
        <table class="my-roles-list">
          <thead>
            <tr><th>Roles</th><th>Resources</th></tr>
          </thead>
          <tbody>
            <tr *ngFor="let roleWres of currentRolesWithResources">
              <td class="column-1"> {{ roleWres.role.name }} </td>
              <td class="column-2"> {{ roleWres.resources.join(', ') }} </td>
            </tr>
          </tbody>
        </table>
      </fieldset>

      <fieldset>
        <legend>My Pending Role Requests.</legend>
        <div class="row">
          <div class="col-3">
            <div class="my-role-label">Add/Change Role Requests</div>
            <select size="3" class="form-control-sm pending-role">
              <option *ngIf="!assignRequests?.length">There are no requests</option>
              <option *ngFor="let req of assignRequests"
                      [disabled]="true">
                      <span *ngIf="req.isNew">(new) - </span>
                      <span *ngIf="!req.isNew">(modify) - </span>
                        {{req.roleName}}
              </option>
            </select>
          </div>
          <div class="col-3">
            <div class="my-role-label">Drop Role Requests</div>
            <select size="3" class="form-control-sm pending-role">
              <option *ngIf="!dropRequests?.length">There are no requests</option>
              <option *ngFor="let dreq of dropRequests"
                      [disabled]="true">
                      <span>(drop) - </span>{{dreq.roleName}}
              </option>
            </select>        
          </div>
        </div>   
      </fieldset>

      <fieldset>
        <legend>Request Role Change</legend>

        <div class="row mb-4">
          <div class="col-3 mb-2 role-controls">
            <label>Select Role</label>
            <span class="form-group">
              <select name="roleSelector" class="form-control-sm dropdown-width"
                [(ngModel)]="selectedRole" (change)="requestExists=false">
                <option value=""></option>
                <option *ngFor="let r of roles" [ngValue]="r">
                  {{ r.name }}
                </option>
              </select>
            </span>
          </div>
          <!-- NEXT BUTTON -->
          <div class="col-2">
            <div class="controls mt-4">
              <button class="btn btn-primary" [disabled]="!selectedRole" (click)="checkRequestsForExisting()">Next</button>
            </div>
          </div>
        </div>

        <div *ngIf="requestExists">
            <p class="role-controls" >A request is pending for the role selected.</p>
        </div>

        <div *ngIf="isVisible">

          <!-- Info -->
          <div>
            <p class="role-controls" >
              <span *ngIf="canUnassign && isNewUserRole">
                Request a new role of <b>{{selectedRole.name}}</b>.
              </span>
              <span *ngIf="canUnassign && !isNewUserRole">
                The <b>{{selectedRole.name}}</b> role has already been assiged.
              </span>
              <span *ngIf="!canUnassign">
                  The <b>{{selectedRole.name}}</b> role cannot be dropped.
              </span>
            </p>
              
          </div>

          <!-- Delete existing -->
          <div *ngIf="canUnassign && !isNewUserRole">
              <p class="role-controls">
                Request to drop the <b>{{selectedRole.name}}</b> role.
              </p>
              <div class="controls pull-right">
                <button class="btn btn-primary" (click)="createDropRequest()">
                  <span>Submit Request</span>
                </button>
              </div>
          </div>

          <!-- Some UserRoleResources can be modified -->
          <div *ngIf="canChangeResources && !isOrgBased">
            <div>
                <p class="role-controls">
                Request to   
                <span *ngIf="isNewUserRole===true">assign</span>
                <span *ngIf="isNewUserRole===false">modify</span>
                access to Programs for the <b>{{selectedRole.name}}</b> role
              </p>
            </div>
            <div style="width:800px;text-align: right; margin-bottom: 10px;">
              <span>Filter Available Programs</span>
              <select name="orgSelector" class="form-control-sm dropdown-width"
                [(ngModel)]="selectedOrganization" (change)="filterByOrg()">
                <option value=""></option>
                <option *ngFor="let org of organizations" [ngValue]="org">
                  {{ org.abbreviation }}
                </option>
              </select>
            </div>  
            <div style="max-width:800px;">
              <dual-list [source]="filteredAvailablePrograms" [(destination)]="assignedPrograms" [key]="key" [display]="display" [sort]="keepSorted"
                [filter]="filter" height="265px" [format]="format" [disabled]="disabled">
              </dual-list>
            </div>
            <br/>
            <div class="controls pull-right">
              <button class="btn btn-primary" (click)="createAssignRequest()">
                <span>Submit Request</span>
              </button>
            </div>
          </div>
          <!-- Some UserRoleResources CANNOT be modified -->
          <div *ngIf="!canChangeResources && isNewUserRole && !isOrgBased">
            <p class="role-controls" *ngIf="!canChangeResources">
              Resource access for the <b>{{selectedRole.name}}</b> role is predeifined and cannot be modified.
            </p>
            <div class="controls pull-right">
              <button class="btn btn-primary" (click)="createAssignRequest()">
                <span>Submit Request</span>
              </button>
            </div>
          </div>

          <!-- Some UserRoleResources are based only on an Organizations -->
          <div *ngIf="isOrgBased" >

            <div  *ngIf="selectedRole.name != 'Organization_Member' && canChangeResources">

              <p class="role-controls">
                <span *ngIf="isNewUserRole===true">Assign</span>
                <span *ngIf="isNewUserRole===false">Modify</span>
                access to Programs based on the {{myOrganization.abbreviation}} Organization for the <b>{{selectedRole.name}}</b>
              </p>
              <div class="controls pull-right">
                <button class="btn btn-primary" (click)="createAssignRequest()">
                  <span>Submit Request</span>
                </button>
              </div>
            </div>

            <div *ngIf="selectedRole.name == 'Organization_Member'">
              <p class="role-controls">
                Change my Organization within this community ( {{myCommunity.abbreviation}} )    
              </p>
              <label>Select New Organization</label>
              <select name="orgSelector" class="form-control-sm dropdown-width"
                [(ngModel)]="selectedOrganization">
                <option value=""></option>
                <option *ngFor="let org of organizations" [ngValue]="org">
                    {{ org.abbreviation }}
                </option>
              </select>
              <div class="controls pull-right">
                <button class="btn btn-primary" (click)="createAssignRequest()">
                  <span>Submit Request</span>
                </button>
              </div>
            </div>

            
          </div>
        </div>

      </fieldset>

      <div class="message">
        <j-feedback></j-feedback>
      </div>
    </div>
  </div>
</div>
